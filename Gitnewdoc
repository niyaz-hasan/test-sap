Reusable Terraform Workflow – Multi-Site Deployment
1. Overview
This document describes the implementation of a centralized, reusable GitHub Actions workflow for Terraform deployments in the repository:
ch-ps-dmc-iris-infra-iac
The reusable workflow supports:
Multi-site (site-specific) deployments
Shared/common infrastructure deployments
Conditional AWS Glue script deployment
Environment-based configuration
Structured validation, error handling, and logging
Secure AWS authentication using OIDC
This implementation eliminates 85–90% workflow duplication across environment-specific pipelines and ensures consistent CI/CD behavior across all environments.
2. Repository Information
Repository Name: ch-ps-dmc-iris-infra-iac
Repository Type: Infrastructure as Code (Terraform)
Primary Branch: main
Workflow Location
Component
Path
Reusable Terraform Workflow
.github/workflows/terraform-reusable.yaml
Environment-Specific Workflows
.github/workflows/iris-deployment-qa.yaml, etc.
Terraform Code
Project Terraform directories
Backend Configuration
S3 + DynamoDB
3. Objectives
The goal of this implementation is to:
Create a centralized reusable workflow using workflow_call
Support both site-specific and shared resource deployments
Introduce configurable feature flags (e.g., Glue deployment toggle)
Standardize configuration using environment variables
Improve deployment reliability and observability
Enforce validation and security scanning in CI/CD
4. Architecture Overview
CI/CD Flow
Checkout Repository
Configure AWS Credentials using OIDC
Verify AWS Authentication
Validate Terraform files exist
Terraform Format Check
Terraform Validate
TFLint (Code Quality Check)
Checkov (Security Scan)
Terraform Init (S3 backend + DynamoDB lock)
Terraform Plan
PR Comment with Plan Output
Terraform Apply (conditional)
Optional Glue Script Deployment
5. Secure AWS Authentication (OIDC)
The workflow uses GitHub OIDC integration to assume AWS roles securely.
Benefits:
No static AWS credentials stored in GitHub
Temporary role-based authentication
Improved security posture
Enterprise-compliant access model
Role assumption is configured using:
aws_account_id
aws_role_name
OIDC trust relationship
6. Multi-Site Deployment Support
The workflow supports deployments across:
Multiple environments (dev, qa, prod)
Multiple sites (site1, site2, etc.)
Shared/common infrastructure
Deployment Types
Site-Specific Resources
Infrastructure deployed per site and environment.
Example:
Copy code

qa-site1
qa-site2
prod-site1
Shared/Common Resources
Infrastructure shared across sites, such as:
IAM roles
Shared S3 buckets
Networking components
Central logging resources
The workflow dynamically determines which components to deploy based on input parameters.
7. Configurable Workflow Inputs
The reusable workflow supports the following inputs:
Input
Description
site
Site identifier
environment
Environment name (dev/qa/prod)
aws_account_id
Target AWS account ID
aws_role_name
IAM role to assume
dynamodb_table
Backend state locking table
apply_changes
Boolean flag to allow terraform apply
deploy_glue_scripts
Boolean flag to enable Glue deployment
8. Environment-Based Configuration
All configuration values are standardized using environment variables instead of hard-coded values.
Examples:
TF_WORKING_DIR
TF_VAR_FILE
AWS_REGION
S3_BUCKET
DYNAMODB_TABLE
Feature flags (Glue toggle)
Benefits:
Cleaner configuration separation
Easier multi-environment scaling
Reduced risk of production misconfiguration
Improved maintainability
9. Terraform Stages
9.1 Terraform Init
Uses S3 backend
Enables encryption
Uses DynamoDB for state locking
Supports backend reconfiguration
9.2 Terraform Format Check
Copy code

terraform fmt -check -recursive
Ensures consistent formatting.
9.3 Terraform Validate
Validates Terraform configuration syntax before execution.
9.4 TFLint
Ensures Terraform best practices
Identifies potential configuration issues
Runs recursively across modules
9.5 Checkov
Security scanning for Terraform code
Policy compliance validation
Soft-fail option for non-blocking warnings
9.6 Terraform Plan
Generates execution plan
Uses detailed exit codes
Stores output
Automatically comments plan in Pull Requests
9.7 Terraform Apply (Conditional)
Executed only if:
apply_changes = true
Triggered from approved branch
No blocking validation errors
10. Pull Request Plan Commenting
When triggered from a PR:
Terraform plan output is automatically posted as a PR comment
Includes:
Site name
Environment
Plan summary
Detailed changes (if applicable)
This improves review transparency and change visibility.
11. Conditional AWS Glue Deployment
The workflow supports a feature flag:
Copy code

deploy_glue_scripts = true | false
Behavior:
If true → Glue deployment step runs
If false → Step is skipped
Benefits:
Faster pipeline execution
Controlled Glue deployments
Reduced production risk
12. Error Handling & Logging
Structured error handling is implemented across:
Terraform validation
Backend initialization
Plan generation
Apply stage
Glue deployment
Improvements:
Clear step naming
Fail-fast mechanism
Explicit error messages
Exit code handling
PR-level visibility
Improved troubleshooting in CI/CD logs
13. Security & Compliance Implementation
This workflow enforces enterprise-grade practices:
OIDC-based AWS authentication
No static AWS secrets stored
Remote state encryption enabled
DynamoDB state locking
Infrastructure linting (TFLint)
Security scanning (Checkov)
PR plan transparency
14. Benefits of This Implementation
85–90% reduction in workflow duplication
Centralized deployment logic
Multi-site scalability
Improved CI/CD consistency
Standardized validation pipeline
Stronger security posture
Improved operational observability
Easier onboarding for new environments
15. Acceptance Criteria Mapping
Requirement
Status
Reusable workflow using workflow_call
Implemented
Multi-site deployment support
Implemented
Conditional Glue deployment
Implemented
Environment variable configuration
Implemented
Structured validation & logging
Implemented
PR plan comment automation
Implemented
16. Future Enhancements
Add Infracost integration
Add Terraform-docs validation
Add drift detection workflow
Add manual approval gate for production
Add deployment artifact archiving
Conclusion
The terraform-reusable.yaml workflow in the ch-ps-dmc-iris-infra-iac repository establishes a scalable, secure, and production-ready CI/CD foundation for multi-site AWS infrastructure deployments.
It significantly reduces duplication, standardizes deployment processes, improves security compliance, and enhances operational visibility across environments.
