######################## locals ########################
# Create a map: db_name => { bucket, prefix, suffix }
locals {
  db_map = {
    for idx, db_name in var.database_names : db_name => {
      bucket = var.bucket_mapping[idx]
      prefix = startswith(db_name, "db_gd") ? "crw_bay_gda" : "qc_grc"
      suffix = reverse(split("_", db_name))[0]
    }
  }
}

################################### glue catalog database #########################################################

resource "aws_glue_catalog_database" "db" {
  for_each = local.db_map

  name        = each.key
  description = "Glue DB for ${each.key}"
}

################################# glue crawler #########################################################################

resource "aws_glue_crawler" "crawler" {
  for_each = local.db_map

  name          = "${each.value.prefix}_${each.value.suffix}-dev"
  database_name = aws_glue_catalog_database.db[each.key].name
  role          = var.iam_role_arn

  s3_target {
    path = "s3://${each.value.bucket}/"
  }
}
